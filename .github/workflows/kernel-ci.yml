name: Kernel CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  kernel-ci:
    name: Kernel CI / KMS guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js (for optional kernel tests)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ensure KMS guard script is executable
        run: chmod +x kernel/ci/require_kms_check.sh

      - name: Run require_kms_check.sh
        env:
          # Set REQUIRE_KMS to "true" in your protected-branch environment (or use repo secret).
          # When REQUIRE_KMS=true the script will fail if KMS_ENDPOINT is not set.
          REQUIRE_KMS: ${{ secrets.REQUIRE_KMS }}
          KMS_ENDPOINT: ${{ secrets.KMS_ENDPOINT }}
        run: |
          echo "Running KMS guard check"
          kernel/ci/require_kms_check.sh

      # Optional: run kernel-local tests if present. This step is safe (it checks for package.json).
      - name: Kernel unit tests (optional)
        working-directory: kernel
        run: |
          if [ -f package.json ]; then
            npm ci
            npm test || (echo "Kernel tests failed (non-blocking for KMS guard)."; exit 1)
          else
            echo "No kernel package.json â€” skipping kernel unit tests."
          fi

