name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  actions: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache marketplace data dir (speedup local dev files)
        uses: actions/cache@v4
        with:
          path: marketplace/server/data
          key: ${{ runner.os }}-marketplace-data
          restore-keys: |
            ${{ runner.os }}-marketplace-data

      - name: Install root dependencies
        working-directory: marketplace
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Lint (frontend & backend)
        working-directory: marketplace
        run: |
          # prefer npm scripts if available, fallback to eslint direct invocation
          if npm run -s lint --silent; then
            exit 0
          else
            npx eslint --ext .ts,.tsx --resolve-plugins-relative-to . .
          fi
        continue-on-error: false

      - name: Typecheck (tsc)
        working-directory: marketplace
        run: |
          if npm run -s typecheck --silent; then
            exit 0
          else
            npx tsc --noEmit
          fi

      - name: Run server unit tests
        working-directory: marketplace
        env:
          NODE_ENV: test
        run: |
          # Prefer an npm script; otherwise run vitest/jest if present
          if npm run -s test:server --silent; then
            exit 0
          elif npm run -s test --silent; then
            exit 0
          else
            npx vitest --run --reporter default
          fi

      - name: Run frontend tests
        working-directory: marketplace/ui
        env:
          NODE_ENV: test
        run: |
          if [ -f package.json ] && jq -r '.scripts["test:ui"]' package.json >/dev/null 2>&1; then
            npm run -s test:ui
          elif npm run -s test --silent; then
            exit 0
          else
            npx vitest --run --reporter default
          fi

      - name: Build server & UI (production build check)
        working-directory: marketplace
        run: |
          # attempt server build (tsc) and frontend build (next build) if scripts exist
          if npm run -s build:server --silent; then
            echo "server build succeeded"
          else
            echo "server build not configured or skipped"
          fi

          if [ -d ui ] && [ -f ui/package.json ]; then
            pushd ui
            if npm run -s build --silent; then
              echo "ui build succeeded"
            else
              echo "ui build not configured or failed"
              exit 1
            fi
            popd
          else
            echo "ui folder not found or no package.json, skipping frontend build"
          fi

      - name: Upload test summaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-test-results
          path: |
            marketplace/test-results || true
            marketplace/ui/test-results || true

  lint-only:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        working-directory: marketplace
        run: npm ci

      - name: ESlint quick check
        working-directory: marketplace
        run: |
          if npm run -s lint --silent; then
            exit 0
          else
            npx eslint --ext .ts,.tsx --resolve-plugins-relative-to . .
          fi

