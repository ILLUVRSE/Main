openapi: 3.1.0
info:
  title: ILLUVRSE Agent Manager API
  version: "1.0.0"
  description: |
    Agent Manager is the runtime responsible for agent templates, spawning,
    lifecycle management, sandbox runs and auditable, signed manifest enforcement.
    This OpenAPI document defines the canonical contract for Agent Manager.
servers:
  - url: http://localhost:5176
    description: Local dev
  - url: https://agent-manager.{env}.illuvrse.internal
    description: Production (mTLS)

security:
  - mutualTLS: []
  - oidc: []

components:
  securitySchemes:
    mutualTLS:
      type: mutualTLS
    oidc:
      type: openIdConnect
      openIdConnectUrl: https://auth.example.com/.well-known/openid-configuration

  schemas:
    Error:
      type: object
      properties:
        ok:
          type: boolean
          const: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
      required:
        - ok
        - error

    AgentConfig:
      type: object
      properties:
        name:
          type: string
        profile:
          type: string
          description: 'Profile determines policy (e.g., "illuvrse" requires signed manifest)'
        metadata:
          type: object
          additionalProperties: true
        codeRef:
          type: string
      required:
        - name
        - profile

    SignedManifestRef:
      type: object
      properties:
        manifestId:
          type: string
        manifestSignatureId:
          type: string
      required:
        - manifestId
        - manifestSignatureId

    SpawnRequest:
      type: object
      properties:
        agent_config:
          $ref: '#/components/schemas/AgentConfig'
        signed_manifest:
          $ref: '#/components/schemas/SignedManifestRef'
        requester:
          type: string
        idempotency_key:
          type: string
      required:
        - agent_config

    SpawnResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        agent_id:
          type: string
        status:
          type: string
      required:
        - ok
        - agent_id
        - status

    AgentStatusResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        agent:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            profile:
              type: string
            state:
              type: string
              enum:
                - created
                - provisioning
                - provisioned
                - starting
                - running
                - paused
                - stopping
                - stopped
                - failed
                - destroyed
            createdAt:
              type: string
              format: date-time
            metadata:
              type: object
              additionalProperties: true
        last_seen:
          type: string
          format: date-time
      required:
        - ok
        - agent

    ActionRequest:
      type: object
      properties:
        action:
          type: string
          enum:
            - start
            - stop
            - restart
            - scale
            - unregister
        scale_to:
          type: integer
          minimum: 0
        reason:
          type: string
      required:
        - action

    ActionResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        agent_id:
          type: string
        status:
          type: string

    Template:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        profile:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        manifest_ref:
          $ref: '#/components/schemas/SignedManifestRef'
      required:
        - id
        - name
        - profile

    TemplatesList:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        templates:
          type: array
          items:
            $ref: '#/components/schemas/Template'

    SandboxRunRequest:
      type: object
      properties:
        tests:
          type: array
          items:
            type: string
        timeout_seconds:
          type: integer
        resources:
          type: object
          properties:
            cpu:
              type: number
            memoryMB:
              type: integer
            network:
              type: boolean
          additionalProperties: false
        environment:
          type: object
          additionalProperties: true
      required:
        - tests

    SandboxRunResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        run_id:
          type: string
        status:
          type: string
          enum:
            - queued
            - running
            - passed
            - failed
            - timeout
      required:
        - ok
        - run_id
        - status

    SandboxRunDetail:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        run:
          type: object
          properties:
            run_id:
              type: string
            agent_id:
              type: string
            status:
              type: string
            started_at:
              type: string
              format: date-time
            finished_at:
              type: string
              format: date-time
            logs:
              type: string
            artifacts:
              type: array
              items:
                type: object
                additionalProperties: true
      required:
        - ok
        - run

  parameters:
    RequestIdHeader:
      name: X-Request-Id
      in: header
      description: "Idempotent request identifier for tracing"
      required: false
      schema:
        type: string
    IdempotencyKeyHeader:
      name: Idempotency-Key
      in: header
      description: "Idempotency key to deduplicate requests"
      required: false
      schema:
        type: string

paths:
  /api/v1/agent/spawn:
    post:
      summary: Spawn a new agent from template/manifest
      operationId: spawnAgent
      security:
        - mutualTLS: []
        - oidc: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpawnRequest'
            examples:
              spawnExample:
                summary: Minimal spawn
                value:
                  agent_config:
                    name: demo
                    profile: personal
                    metadata:
                      owner: ryan
      parameters:
        - $ref: '#/components/parameters/RequestIdHeader'
        - $ref: '#/components/parameters/IdempotencyKeyHeader'
      responses:
        "201":
          description: Agent instantiation accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpawnResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: unsigned or invalid manifest for profile requiring signed manifests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/{id}/status:
    get:
      summary: Retrieve agent snapshot and recent metrics
      operationId: getAgentStatus
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "200":
          description: agent state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentStatusResponse'
        "404":
          description: not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/{id}:
    get:
      summary: Fetch agent profile
      operationId: getAgent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "200":
          description: agent profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentStatusResponse'
        "404":
          description: not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/{id}/action:
    post:
      summary: Perform lifecycle action on agent (start/stop/restart/scale/unregister)
      operationId: agentAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActionRequest'
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "200":
          description: action accepted / status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'
        "400":
          description: invalid action or payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: forbidden (RBAC)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/templates:
    get:
      summary: List agent templates
      operationId: listTemplates
      parameters:
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "200":
          description: list of templates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplatesList'
    post:
      summary: Create a new agent template
      operationId: createTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Template'
      responses:
        "201":
          description: template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/{id}/sandbox/run:
    post:
      summary: Create a sandbox run for the given agent
      operationId: createSandboxRun
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SandboxRunRequest'
            examples:
              basic:
                value:
                  tests: ["unit:test-suite"]
                  timeout_seconds: 300
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "202":
          description: sandbox run accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SandboxRunResponse'
        "400":
          description: invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/sandbox/run/{run_id}:
    get:
      summary: Retrieve sandbox run details
      operationId: getSandboxRun
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestIdHeader'
      responses:
        "200":
          description: sandbox run detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SandboxRunDetail'
        "404":
          description: run not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# Top-level tags for organization
tags:
  - name: agent
    description: Agent lifecycle and info
  - name: templates
    description: Agent template management
  - name: sandbox
    description: Sandbox testing / preview

# Example servers / usage notes
x-notes:
  - "Production: server-to-server traffic must use mTLS; human flows use OIDC."
  - "Agent Manager enforces signed manifests when profile === 'illuvrse'. Invalid or missing signatures must yield 403."
  - "All state-changing calls should emit AuditEvent entries (see kernel audit-log-spec)."

