# kernel/env.sample
# Example environment variables for Kernel + Agent Manager (audit signing / verification)
# Copy this file and fill in real values for your environment (e.g., env.production).

########################################
# Database
########################################
# Postgres connection used by kernel/agent-manager for audit events and other storage
DATABASE_URL=postgres://postgres:password@localhost:5432/illuvrse_db

########################################
# Agent Manager: Audit signing configuration
########################################
# AUDIT_SIGNING_KEY_SOURCE: choose where the signing key comes from.
#   - env  : read private key / secret from AUDIT_SIGNING_PRIVATE_KEY
#   - file : read private key from AUDIT_SIGNING_KEY_PATH
#   - url  : fetch key json from AUDIT_SIGNING_KEY_URL
#   - kms  : use KMS (AUDIT_SIGNING_KMS_KEY_ID must be set)
AUDIT_SIGNING_KEY_SOURCE=kms

# When using an env/file/url key source -> provide private key or secret here.
# For HMAC: provide the raw secret. For RSA/ED25519: provide PEM text. (Keep secret!)
# Example: AUDIT_SIGNING_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
AUDIT_SIGNING_PRIVATE_KEY=

# When using file source: path to private key
AUDIT_SIGNING_KEY_PATH=/secrets/audit_signing_key.pem

# When using url source: URL that returns JSON { kid, alg, key }
AUDIT_SIGNING_KEY_URL=https://secrets.example.com/audit_signing_key

# KMS configuration (when AUDIT_SIGNING_KEY_SOURCE=kms)
# KeyId/ARN for the KMS key to use for signing audit digests.
AUDIT_SIGNING_KMS_KEY_ID=arn:aws:kms:us-east-1:123456789012:key/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# Algorithm the signer/key uses. Supported values:
#   - rsa-sha256  (RSA PKCS#1 v1.5 / PSS semantics for verification)
#   - ed25519
#   - hmac-sha256
AUDIT_SIGNING_ALG=rsa-sha256

# Logical identifier (kid) for the signer. For KMS this may be the KeyId/ARN;
# for env/file it can be any short string used to identify the signer in DB.
AUDIT_SIGNER_KID=audit-signing-key-v1

# AWS region if using AWS KMS
AWS_REGION=us-east-1
# or
# AWS_DEFAULT_REGION=us-east-1

########################################
# Kernel: signers registry & verification
########################################
# Kernel verifier reads a registry of public keys. You can supply it in one of:
#  - environment variable KERNEL_PUBLIC_KEYS_JSON (JSON string)
#  - file KERNEL_PUBLIC_KEYS_PATH (path to JSON file)
#  - URL KERNEL_PUBLIC_KEYS_URL (fetches JSON)
#
# The JSON shape:
# {
#   "signers": [
#     { "signerId": "name-or-keyid", "algorithm": "rsa-sha256", "publicKey": "-----BEGIN PUBLIC KEY-----..." },
#     { "signerId": "ed25519-1", "algorithm": "ed25519", "publicKey": "<base64 DER or PEM>" }
#   ]
# }
KERNEL_PUBLIC_KEYS_JSON=
KERNEL_PUBLIC_KEYS_PATH=/secrets/kernel_signers.json
KERNEL_PUBLIC_KEYS_URL=https://keys.example.com/signers.json

# If you prefer a single shared HMAC secret for testing/fallback (not recommended for prod)
KERNEL_SHARED_SECRET=

########################################
# CI / policy guards
########################################
# REQUIRE_KMS: when true, CI/prod-run must have KMS configured (used by kernel/ci/require_kms_check.sh)
# Set this to "true" in protected branches/environments to prevent ephemeral keys being used.
REQUIRE_KMS=false

# If REQUIRE_KMS=true, CI must set KMS_ENDPOINT or set AUDIT_SIGNING_KMS_KEY_ID appropriately
# KMS_ENDPOINT is used by signing proxy implementations or custom KMS HTTP proxies (if applicable)
KMS_ENDPOINT=

########################################
# Optional: KMS HTTP signing proxy credentials
########################################
# If you use a signing proxy (HTTP) instead of direct AWS SDK calls, configure:
# KMS_PROXY_URL=https://kms-proxy.example.com
# KMS_PROXY_BEARER_TOKEN=xxx
KMS_PROXY_URL=
KMS_PROXY_BEARER_TOKEN=

########################################
# Debugging & test hooks (do not use in production)
########################################
# Allow local dev to skip KMS enforcement and use ephemeral keys
DEV_ALLOW_EPHEMERAL=true

# Log level for Node processes (debug/info/warn/error)
LOG_LEVEL=info

########################################
# Notes
########################################
# * For production, prefer AUDIT_SIGNING_KEY_SOURCE=kms with an asymmetric key (RSA or ED25519).
# * Set REQUIRE_KMS=true in CI for protected branches and ensure KMS credentials/endpoint are available.
# * Use kernel/tools/signers.json (or KERNEL_PUBLIC_KEYS_* env) to publish public keys used by the verifier.
# * When rotating keys: add the new public key to the signers registry before switching the signer used by agent-manager.
#
# Example sequence for KMS RSA:
# 1) Create KMS RSA key with KeyUsage=SIGN_VERIFY, CustomerMasterKeySpec=RSA_2048
# 2) Set AUDIT_SIGNING_KMS_KEY_ID to the key ARN and AUDIT_SIGNING_ALG=rsa-sha256
# 3) Export the public key (GetPublicKey) and add it to kernel/tools/signers.json
# 4) Deploy agent-manager with these env vars, run smoke/e2e tests

