version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: illuvrse
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-illuvrse} || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 12
    volumes:
      - postgres-data:/var/lib/postgresql/data

  keycloak:
    # Use a Keycloak image appropriate for your environment. The startup below works for Keycloak 17+ (Quarkus).
    build:
      context: ./keycloak
      dockerfile: Dockerfile
    environment:
      KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN:-admin}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD:-admin}"
    command: ["start-dev", "--http-port=8080"]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/q/health/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 36
    ports:
      - "8080:8080"

  mock-kms:
    build:
      context: ./mock-kms
      dockerfile: Dockerfile
    image: illuvrse/mock-kms:local
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "8080:8080"

  kernel:
    build:
      context: ../kernel
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      mock-kms:
        condition: service_healthy
    environment:
      POSTGRES_URL: "postgresql://postgres:postgres@postgres:5432/illuvrse"
      ILLUVRSE_CERT_DIR: "/etc/illuvrse/certs"
      OIDC_ISSUER: "${OIDC_ISSUER:-http://keycloak:8080/realms/testrealm}"
      OIDC_AUDIENCE: "${OIDC_AUDIENCE:-kernel-client}"
      MTLS_CERT: "/etc/illuvrse/certs/kernel-server.crt"
      MTLS_KEY: "/etc/illuvrse/certs/kernel-server.key"
      MTLS_CLIENT_CA: "/etc/illuvrse/certs/kernel-ca.crt"
      MTLS_REQUIRE_CLIENT_CERT: "${MTLS_REQUIRE_CLIENT_CERT:-false}"
      NODE_EXTRA_CA_CERTS: "/etc/illuvrse/certs/kernel-ca.crt"
      ENABLE_TEST_ENDPOINTS: "${ENABLE_TEST_ENDPOINTS:-true}"
      KMS_ENDPOINT: "${KMS_ENDPOINT:-http://mock-kms:8080}"
      REQUIRE_KMS: "${REQUIRE_KMS:-false}"
      SIGNER_ID: "${SIGNER_ID:-kernel-signer-local}"
    ports:
      - "3000:3000"
    volumes:
      - "${ILLUVRSE_CERT_DIR:-../devops/certs}:/etc/illuvrse/certs:ro"
    healthcheck:
      test: ["CMD-SHELL", "sh -c \"cat /proc/net/tcp | grep -q ':0*BB8\\\\b' || exit 1\""]
      interval: 5s
      timeout: 5s
      retries: 36

  memory-layer:
    build:
      context: ../
      dockerfile: ./memory-layer/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      mock-kms:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    environment:
      # DB
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/illuvrse"
      # runtime
      NODE_ENV: "${NODE_ENV:-test}"
      PORT: "${PORT:-4300}"
      # signing - point at mock-kms running on host (docker-compose network)
      SIGNING_PROXY_URL: "http://mock-kms:8080"
      REQUIRE_KMS: "${REQUIRE_KMS:-true}"
      # OIDC (if tests require auth)
      OIDC_ISSUER: "${OIDC_ISSUER:-http://keycloak:8080/realms/testrealm}"
      OIDC_AUDIENCE: "${OIDC_AUDIENCE:-memory-layer-client}"
      # Vector (local dev uses postgres provider)
      VECTOR_DB_PROVIDER: "${VECTOR_DB_PROVIDER:-postgres}"
      VECTOR_DB_NAMESPACE: "${VECTOR_DB_NAMESPACE:-kernel-memory}"
      # Optional
      VECTOR_WRITE_QUEUE: "${VECTOR_WRITE_QUEUE:-true}"
      VECTOR_WORKER_POLL: "${VECTOR_WORKER_POLL:-true}"
      # Make sure OpenAPI spec is present in image runtime
      OPENAPI_SPEC_PATH: "/app/dist/memory-layer/api/openapi.yaml"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4300/healthz || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      - "4300:4300"
    # Bind mount for local dev - optional
    volumes:
      - ../memory-layer:/app/dist/memory-layer:ro

networks:
  default:
    name: illuvrse_ci_default

volumes:
  postgres-data:

