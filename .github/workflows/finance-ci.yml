name: Finance CI

on:
  push:
    paths:
      - 'finance/**'
  pull_request:
    paths:
      - 'finance/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  REQUIRE_KMS: ${{ secrets.REQUIRE_KMS || 'false' }}
  REQUIRE_SIGNING_PROXY: ${{ secrets.REQUIRE_SIGNING_PROXY || 'false' }}

jobs:
  build-and-unit:
    name: Build & Unit / Ledger Tests
    runs-on: ubuntu-latest
    outputs:
      unit-result: ${{ steps.unit.outputs.result || 'ok' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: finance/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Install Postgres client tools
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Lint (if configured)
        working-directory: finance
        run: |
          if jq -e '.scripts | has("lint")' finance/package.json >/dev/null 2>&1; then
            npm run lint || true
          fi

      - name: Run unit tests (ledger balance / idempotency)
        id: unit
        run: npx vitest run --config finance/vitest.config.ts finance/test/unit --runInBand

      - name: Check for private keys
        working-directory: .
        run: |
          if [ -x finance/scripts/ci/check-no-private-keys.sh ]; then
            finance/scripts/ci/check-no-private-keys.sh
          else
            # Basic grep fallback (best-effort)
            if git grep -n -- '*-----BEGIN PRIVATE KEY-----' || git grep -n -- '*.pem' || git grep -n -- 'AKIA'; then
              echo "Possible private key or secret found" && exit 1 || true
            else
              echo "No obvious private keys found by quick grep"
            fi
          fi

      - name: Upload unit test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: finance-unit-results
          path: |
            finance/vitest-report.html || true
            finance/coverage || true

  e2e:
    name: E2E Acceptance (checkout-ledger)
    runs-on: ubuntu-latest
    needs: build-and-unit
    timeout-minutes: 40
    env:
      POSTGRES_DB: finance_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: 5440
      S3_ENDPOINT: http://localhost:9000
      S3_ACCESS_KEY: minio
      S3_SECRET: minio123
      MOCK_SIGNING_PROXY: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: finance/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Start local orchestration for E2E (DB + signing-proxy mock)
        working-directory: finance
        run: |
          # This expects a run-local.sh or docker-compose.dev.yml in finance/
          if [ -x ./run-local.sh ]; then
            ./run-local.sh
            # Wait for health probe
            for i in $(seq 1 40); do
              if curl -fsS http://127.0.0.1:8050/health >/dev/null 2>&1; then
                echo "finance local started"
                break
              fi
              echo "waiting for local services..."
              sleep 2
            done
          else
            echo "run-local.sh not found in finance/ - please provide orchestration for E2E" && exit 1
          fi

      - name: Run E2E tests (checkout-ledger)
        env:
          FINANCE_BASE_URL: http://127.0.0.1:8050
        run: |
          npx vitest run --config finance/vitest.config.ts finance/test/e2e/payment_payout_flow.test.ts --runInBand || (echo "E2E tests failed" && exit 1)

      - name: Dump ledger database
        if: success()
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PORT: ${{ env.POSTGRES_PORT }}
        run: |
          pg_dump -h 127.0.0.1 -p ${POSTGRES_PORT:-5440} -U ${POSTGRES_USER:-postgres} ${POSTGRES_DB:-finance_dev} > finance-ledger.sql

      - name: Upload ledger dump
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: finance-ledger-dump
          path: finance-ledger.sql

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: finance-e2e-artifacts
          path: |
            finance/test-results/**
            finance/vitest-report.html || true
            /tmp/finance-run-local.pid || true

      - name: Teardown local orchestration
        if: always()
        run: |
          ./finance/run-local.sh teardown || true

  audit-verify:
    name: Audit Verification
    runs-on: ubuntu-latest
    needs: e2e
    if: ${{ needs.e2e.result == 'success' }}
    env:
      POSTGRES_DB: finance_verify
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: 5540
      SIGNING_PROXY_PORT: 9100
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download ledger dump
        uses: actions/download-artifact@v4
        with:
          name: finance-ledger-dump
          path: artifacts

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install kernel dependencies
        working-directory: kernel
        run: npm ci

      - name: Install Postgres client tools
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Start Postgres for verification
        run: |
          docker run -d --name finance-ci-verify-db \
            -e POSTGRES_USER="${POSTGRES_USER}" \
            -e POSTGRES_PASSWORD="${POSTGRES_PASSWORD}" \
            -e POSTGRES_DB="${POSTGRES_DB}" \
            -p "${POSTGRES_PORT}:5432" \
            postgres:15-alpine >/dev/null
          for i in $(seq 1 30); do
            if pg_isready -h 127.0.0.1 -p ${POSTGRES_PORT} -U ${POSTGRES_USER} >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done

      - name: Restore ledger dump
        env:
          PGPASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          psql -h 127.0.0.1 -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f artifacts/finance-ledger.sql

      - name: Start signing proxy mock
        run: |
          node kernel/mock/signingProxyMock.js > /tmp/finance-signing-proxy.log 2>&1 &
          echo $! > /tmp/finance-signing-proxy.pid

      - name: Generate and verify ledger proof
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@127.0.0.1:${{ env.POSTGRES_PORT }}/${{ env.POSTGRES_DB }}
          SIGNING_PROXY_URL: http://127.0.0.1:${{ env.SIGNING_PROXY_PORT }}
          SIGNERS_PATH: kernel/tools/signers.json
          PROOF_OUT: finance/ci-proof.json
        run: |
          ./finance/tools/ci_generate_and_verify_proof.sh --signers "${SIGNERS_PATH}" --out "${PROOF_OUT}"

      - name: Upload proof artifact
        uses: actions/upload-artifact@v4
        with:
          name: finance-ledger-proof
          path: finance/ci-proof.json

      - name: Teardown verification services
        if: always()
        run: |
          if [ -f /tmp/finance-signing-proxy.pid ]; then
            kill $(cat /tmp/finance-signing-proxy.pid) || true
            rm -f /tmp/finance-signing-proxy.pid
          fi
          docker rm -f finance-ci-verify-db >/dev/null 2>&1 || true

  require-signing-check:
    name: Signing Path Guard (protected branches)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Signing / KMS check
        env:
          REQUIRE_KMS: ${{ env.REQUIRE_KMS }}
          REQUIRE_SIGNING_PROXY: ${{ env.REQUIRE_SIGNING_PROXY }}
          SIGNING_PROXY_URL: ${{ secrets.SIGNING_PROXY_URL || '' }}
          KMS_ENDPOINT: ${{ secrets.KMS_ENDPOINT || '' }}
        run: ./kernel/ci/require_kms_check.sh
