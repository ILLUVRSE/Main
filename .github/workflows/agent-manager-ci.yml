name: Agent Manager CI

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:

# Default token permissions for the workflow. id-token: write is required for OIDC.
permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write

jobs:
  # ------------------------------------------------------------
  # Basic secrets check job (fail fast if repo secrets are missing)
  # ------------------------------------------------------------
  secrets_check:
    name: Verify required repo secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required repository secrets
        id: verify-secrets
        run: |
          set -euo pipefail

          # Explicit checks so missing secrets are visible in logs
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            echo "::error::Missing secret: AWS_REGION"
            exit 1
          fi

          if [ -z "${{ secrets.AUDIT_SIGNING_KMS_KEY_ID }}" ]; then
            echo "::error::Missing secret: AUDIT_SIGNING_KMS_KEY_ID"
            exit 1
          fi

          if [ -z "${{ secrets.REQUIRE_KMS }}" ]; then
            echo "::error::Missing secret: REQUIRE_KMS"
            exit 1
          fi

          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "::error::Missing secret: AWS_ROLE_ARN"
            exit 1
          fi

          echo "All required secrets present."

  # ------------------------------------------------------------
  # KMS availability + CI wiring job
  # This sets AUDIT_SIGNING_KEY_SOURCE=kms and fails the run if
  # REQUIRE_KMS=true and KMS is inaccessible.
  # ------------------------------------------------------------
  kms-signing-check:
    name: KMS Signing availability & CI wiring
    runs-on: ubuntu-latest
    needs: secrets_check
    permissions:
      contents: write
      pull-requests: write
      actions: read
      id-token: write
    env:
      AUDIT_SIGNING_KEY_SOURCE: kms
      AUDIT_SIGNING_KMS_KEY_ID: ${{ secrets.AUDIT_SIGNING_KMS_KEY_ID }}
      REQUIRE_KMS: ${{ secrets.REQUIRE_KMS }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure KMS key available
        id: kms_check
        run: |
          set -euo pipefail

          if [ -z "${AUDIT_SIGNING_KMS_KEY_ID:-}" ]; then
            echo "::error:: AUDIT_SIGNING_KMS_KEY_ID is not set"
            exit 1
          fi

          KEY_ID="$AUDIT_SIGNING_KMS_KEY_ID"
          echo "Checking KMS key: $KEY_ID"

          # cheap check: describe-key
          if ! aws kms describe-key --key-id "$KEY_ID" >/dev/null 2>&1; then
            echo "::error:: KMS DescribeKey failed for $KEY_ID"
            if [ "${REQUIRE_KMS:-true}" = "true" ]; then
              exit 2
            else
              exit 0
            fi
          fi

          # confirm public key retrievable (permission + asymmetric key)
          if ! aws kms get-public-key --key-id "$KEY_ID" >/dev/null 2>&1; then
            echo "::warning:: aws kms get-public-key failed (permission or non-asymmetric key)"
            if [ "${REQUIRE_KMS:-true}" = "true" ]; then
              echo "::error:: KMS GetPublicKey not available and REQUIRE_KMS=true"
              exit 3
            else
              exit 0
            fi
          fi

          echo "KMS key accessible and public key retrievable: $KEY_ID"

      - name: Export AUDIT_SIGNING_KEY_SOURCE for downstream
        run: echo "AUDIT_SIGNING_KEY_SOURCE=kms" >> $GITHUB_ENV

  # ------------------------------------------------------------
  # Update signers.json from KMS (safe, auditable -- creates PR)
  # Trigger: you can run this job manually with workflow_dispatch or
  # call it from a deploy pipeline. It will create a branch and PR.
  # This job expects `scripts/update-signers-from-kms.sh` to exist.
  # ------------------------------------------------------------
  update-signers-from-kms:
    name: Update kernel/tools/signers.json from KMS
    runs-on: ubuntu-latest
    needs: kms-signing-check
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq openssl ca-certificates
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo apt-add-repository https://cli.github.com/packages
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Configure GH CLI for PR creation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token

      - name: Run update signers script
        env:
          AUDIT_SIGNING_KMS_KEY_ID: ${{ secrets.AUDIT_SIGNING_KMS_KEY_ID }}
        run: |
          chmod +x scripts/update-signers-from-kms.sh
          ./scripts/update-signers-from-kms.sh

  # ------------------------------------------------------------
  # Prod audit-verify (manual run)
  # ------------------------------------------------------------
  prod-audit-verify:
    name: Prod audit-verify (manual)
    runs-on: ubuntu-latest
    needs: kms-signing-check
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      id-token: write
    env:
      PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
      AUDIT_SIGNING_KMS_KEY_ID: ${{ secrets.AUDIT_SIGNING_KMS_KEY_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install kernel deps
        working-directory: kernel
        run: npm ci

      - name: Run kernel audit-verify against PROD DB
        working-directory: kernel
        env:
          POSTGRES_URL: ${{ env.PROD_DB_URL }}
          AUDIT_SIGNING_KMS_KEY_ID: ${{ env.AUDIT_SIGNING_KMS_KEY_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          node tools/audit-verify.js -d "${POSTGRES_URL}" -s tools/signers.json

  # ------------------------------------------------------------
  # Example: run tests / build after KMS check passes
  # - This is an example job that depends on kms-signing-check.
  # - Modify the commands inside to match your repo's test commands.
  # ------------------------------------------------------------
  test:
    name: Run tests (depends on KMS wiring)
    runs-on: ubuntu-latest
    needs: kms-signing-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Run unit tests
        run: |
          npm test

