openapi: 3.1.0
info:
  title: ILLUVRSE Memory Layer API
  version: "1.0.0"
  description: >
    Memory Layer API â€” canonical contract for storing memory nodes, embeddings,
    artifacts, and managing retention/legal-hold. All state-changing operations
    MUST emit an AuditEvent that conforms to the Kernel audit-log-spec. Production
    requires mTLS for service calls and OIDC for human flows.

servers:
  - url: http://localhost:4300
    description: local dev
  - url: https://memory-layer.{env}.illuvrse.internal
    description: production (mTLS)

security:
  - mutualTLS: []
  - oidc: []

components:
  securitySchemes:
    mutualTLS:
      type: mutualTLS
    oidc:
      type: openIdConnect
      openIdConnectUrl: https://auth.example.com/.well-known/openid-configuration

  parameters:
    RequestId:
      name: X-Request-Id
      in: header
      description: "Optional request id for tracing"
      schema:
        type: string
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      description: "Idempotency key to deduplicate requests"
      schema:
        type: string

  schemas:
    Error:
      type: object
      properties:
        ok:
          type: boolean
          const: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
      required:
        - ok
        - error

    MemoryNode:
      type: object
      description: >
        Canonical memory node stored in Memory Layer. Writes must be accompanied by
        an audit emission.
      properties:
        id:
          type: string
          description: "Unique node id (uuid or string)"
        embeddingId:
          type: string
        payload:
          type: object
          additionalProperties: true
        metadata:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - payload

    CreateMemoryNodeRequest:
      type: object
      properties:
        node:
          $ref: '#/components/schemas/MemoryNode'
        audit_context:
          type: object
          description: "Audit context linking to kernel manifestSignatureId, request info"
          additionalProperties: true
      required:
        - node

    CreateMemoryNodeResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        node_id:
          type: string
        created_at:
          type: string
          format: date-time

    Embedding:
      type: object
      properties:
        id:
          type: string
        vector:
          type: array
          items:
            type: number
        node_id:
          type: string
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - vector
        - node_id

    StoreEmbeddingRequest:
      type: object
      properties:
        embedding:
          $ref: '#/components/schemas/Embedding'
        idempotency_key:
          type: string
      required:
        - embedding

    StoreEmbeddingResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        embedding_id:
          type: string

    EmbeddingSearchRequest:
      type: object
      properties:
        query_vector:
          type: array
          items:
            type: number
        top_k:
          type: integer
          default: 10
          minimum: 1
        filter:
          type: object
          description: "Optional metadata filters (simple equality / ranges)."
          additionalProperties: true
        include_vectors:
          type: boolean
          default: false
      required:
        - query_vector

    EmbeddingMatch:
      type: object
      properties:
        embedding_id:
          type: string
        node_id:
          type: string
        score:
          type: number
        metadata:
          type: object
          additionalProperties: true
        vector:
          type: array
          items:
            type: number

    EmbeddingSearchResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        matches:
          type: array
          items:
            $ref: '#/components/schemas/EmbeddingMatch'

    ArtifactUploadRequest:
      type: object
      properties:
        filename:
          type: string
        content_type:
          type: string
        size_bytes:
          type: integer
        metadata:
          type: object
          additionalProperties: true
        idempotency_key:
          type: string
      required:
        - filename
        - content_type
        - size_bytes

    ArtifactUploadResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        upload_url:
          type: string
          description: "Presigned URL (PUT) for artifact upload"
        upload_id:
          type: string
        expires_at:
          type: string
          format: date-time

    ArtifactCompleteRequest:
      type: object
      properties:
        upload_id:
          type: string
        sha256:
          type: string
        manifest_signature_id:
          type: string
      required:
        - upload_id
        - sha256

    ArtifactCompleteResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true
        artifact_id:
          type: string
        artifact_url:
          type: string
        sha256:
          type: string

    RetentionRequest:
      type: object
      properties:
        artifact_id:
          type: string
        ttl_days:
          type: integer
        legal_hold:
          type: boolean
      required:
        - artifact_id

    RetentionResponse:
      type: object
      properties:
        ok:
          type: boolean
          const: true

paths:
  /health:
    get:
      summary: Liveness probe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  ts:
                    type: string
                    format: date-time

  /ready:
    get:
      summary: Readiness probe (DB + Vector DB + signer)
      responses:
        "200":
          description: ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  dbOk:
                    type: boolean
                  vectorOk:
                    type: boolean
                  signerOk:
                    type: boolean
        "503":
          description: not ready

  /memory/nodes:
    post:
      tags:
        - memory
      summary: Create a memory node (append-only)
      description: >
        Create a MemoryNode. Must emit an AuditEvent. If node.id exists the API should reject or be idempotent based on Idempotency-Key.
      security:
        - mutualTLS: []
        - oidc: []
      parameters:
        - $ref: '#/components/parameters/RequestId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMemoryNodeRequest'
      responses:
        "201":
          description: Node created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateMemoryNodeResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: conflict / already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /memory/nodes/{id}:
    get:
      tags:
        - memory
      summary: Get a memory node by id
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestId'
      responses:
        "200":
          description: memory node
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryNode'
        "404":
          description: not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /memory/embeddings:
    post:
      tags:
        - embeddings
      summary: Store an embedding
      security:
        - mutualTLS: []
        - oidc: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoreEmbeddingRequest'
      responses:
        "201":
          description: embedding stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreEmbeddingResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /memory/embeddings/search:
    post:
      tags:
        - embeddings
      summary: Search for nearest embeddings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmbeddingSearchRequest'
      responses:
        "200":
          description: search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingSearchResponse'
        "400":
          description: invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /artifacts/upload:
    post:
      tags:
        - artifacts
      summary: Request a presigned upload URL for an artifact
      description: >
        Returns a presigned URL for client to PUT the artifact. Implementation must record a pending upload and return upload_id.
      security:
        - mutualTLS: []
        - oidc: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtifactUploadRequest'
      responses:
        "200":
          description: presigned upload info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactUploadResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /artifacts/complete:
    post:
      tags:
        - artifacts
      summary: Complete an artifact upload and create artifact record
      description: >
        Validate the computed sha256 and produce an artifact record with artifact_url (S3 or equivalent).
        Emit AuditEvent referencing manifestSignatureId when provided.
      security:
        - mutualTLS: []
        - oidc: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtifactCompleteRequest'
      responses:
        "200":
          description: artifact finalized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactCompleteResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "409":
          description: mismatch or duplicate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /artifacts/{artifact_id}:
    get:
      tags:
        - artifacts
      summary: Fetch artifact metadata
      parameters:
        - name: artifact_id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/RequestId'
      responses:
        "200":
          description: artifact metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactCompleteResponse'
        "404":
          description: not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /artifacts/retention:
    post:
      tags:
        - artifacts
      summary: Set TTL / legal hold for an artifact
      security:
        - mutualTLS: []
        - oidc: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetentionRequest'
      responses:
        "200":
          description: retention updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetentionResponse'
        "400":
          description: validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# Tags
tags:
  - name: memory
    description: Memory node operations
  - name: embeddings
    description: Embedding storage & search
  - name: artifacts
    description: Artifact upload & retention

x-notes:
  - "All write operations MUST emit AuditEvent with prevHash/hash/signature that can be verified by kernel/tools/audit-verify.js"
  - "Embedding store should support queue fallback when external vector provider is unavailable (`VECTOR_WRITE_QUEUE`)."
  - "Presigned uploads should follow the principle: server issues presigned PUT, client performs PUT, client calls /artifacts/complete with computed sha256."

